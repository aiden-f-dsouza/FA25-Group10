{% for n in notes %}
<div class="card">
  <!-- Note content (visible by default, hidden when editing) -->
  <div id="note-content-{{ n.id }}" class="note-content">
    <!-- Note title (clickable headline) -->
    <div class="note-title">{{ n.title }}</div>

    <!-- Metadata tags (author, date, class as badges) -->
    <div class="note-meta">
      <span class="meta-tag"><i class="ph ph-user"></i> {{ n.author }}</span>
      <span class="meta-tag"><i class="ph ph-calendar"></i> {{ n.created.strftime('%Y-%m-%d %H:%M') }}</span>
      <span class="meta-tag"><i class="ph ph-book-open"></i> {{ n.class_code }}</span>
      <span class="meta-tag"><i class="ph-fill ph-heart" style="color: #ef4444;"></i> {{ n.likes|length }}</span>
      <span class="meta-tag"><i class="ph ph-chat-circle"></i> {{ n.comments|length }}</span>
      {# Tags badges on note #}
      {% if n.get_tags_list() %}
        {% for tag in n.get_tags_list() %}
          <a href="/?tag_filter={{ tag }}" class="meta-tag" style="text-decoration:none;">#{{ tag }}</a>
        {% endfor %}
      {% endif %}
      {# Hashtags badges on note #}
      {% if n.get_hashtags() %}
        {% for ht in n.get_hashtags() %}
          <a href="/?tag_filter={{ ht }}" class="meta-tag" style="text-decoration:none; background:rgba(245,101,101,0.2); color:#c53030;">#{{ ht }}</a>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Note content/body -->
    <div class="note-body">{{ n.body }}</div>

    <!-- Attachments section (only show if note has attachments) -->
    {% if n.attachments %}
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(102, 126, 234, 0.2);">
      <div style="font-size: 13px; font-weight: 600; color: #a0a3bd; margin-bottom: 8px;">
        <i class="ph ph-paperclip"></i> Attachments ({{ n.attachments|length }}):
      </div>
      <!-- List of downloadable attachments -->
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        {% for attachment in n.attachments %}
        <!-- Each attachment as a download link with file type badge -->
        <a href="/download/{{ attachment.id }}"
           style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(102, 126, 234, 0.2); border-radius: 8px; color: #667eea; text-decoration: none; font-size: 13px; transition: all 0.3s ease; border: 1px solid rgba(102, 126, 234, 0.3);"
           onmouseover="this.style.background='rgba(102, 126, 234, 0.3)'; this.style.transform='translateY(-2px)'"
           onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'; this.style.transform='translateY(0)'">
          <!-- File type icon based on extension -->
          {% if attachment.file_type == 'pdf' %}<i class="ph ph-file-pdf"></i>
          {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}<i class="ph ph-image"></i>
          {% elif attachment.file_type in ['doc', 'docx'] %}<i class="ph ph-file-doc"></i>
          {% elif attachment.file_type in ['ppt', 'pptx'] %}<i class="ph ph-file-ppt"></i>
          {% else %}<i class="ph ph-paperclip"></i>
          {% endif %}
          <!-- Display original filename -->
          <span>{{ attachment.original_filename }}</span>
          <!-- Download icon -->
          <span style="opacity: 0.7;"><i class="ph ph-download-simple"></i></span>
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Edit form (hidden by default, shown when edit button is clicked) -->
  <div id="edit-form-{{ n.id }}" class="edit-form">
    <form method="POST" action="/edit/{{ n.id }}" enctype="multipart/form-data">
      <!-- Title input for editing -->
      <div style="margin-bottom: 12px;">
        <input type="text" name="title" value="{{ n.title }}" placeholder="Note title" required style="width: 100%;">
      </div>

      <!-- Author is fixed and cannot be changed (shows current author) -->
      <div style="margin-bottom: 12px; color: #888; font-size: 14px;">
        Author: {{ n.author }}
      </div>

      <!-- Class selector for editing -->
      <div style="margin-bottom: 12px;">
        <select name="class" style="width: 100%;">
          {% for c in classes %}
          <option value="{{ c }}" {% if c == n.class_code %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Body textarea for editing -->
      <div style="margin-bottom: 12px;">
        <textarea name="body" placeholder="Note content" required style="width: 100%; min-height: 120px;">{{ n.body }}</textarea>
      </div>

      <!-- Tags input for editing (comma-separated) -->
      <div style="margin-bottom: 12px;">
        <input type="text" name="tags" value="{{ n.get_tags_list()|join(', ') }}" placeholder="tags (comma-separated)" style="width:100%;">
      </div>

      <!-- Existing attachments management -->
      {% if n.attachments %}
      <div style="margin-bottom: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
        <div style="font-size: 13px; font-weight: 600; color: #a0a3bd; margin-bottom: 8px;">
          <i class="ph ph-paperclip"></i> Existing Attachments:
        </div>
        {% for attachment in n.attachments %}
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <input type="checkbox" name="delete_attachments" value="{{ attachment.id }}" id="delete-{{ attachment.id }}">
          <label for="delete-{{ attachment.id }}" style="cursor: pointer; font-size: 13px; color: #e4e6eb;">
            {% if attachment.file_type == 'pdf' %}<i class="ph ph-file-pdf"></i>
            {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}<i class="ph ph-image"></i>
            {% elif attachment.file_type in ['doc', 'docx'] %}<i class="ph ph-file-doc"></i>
            {% elif attachment.file_type in ['ppt', 'pptx'] %}<i class="ph ph-file-ppt"></i>
            {% else %}<i class="ph ph-paperclip"></i>
            {% endif %}
            {{ attachment.original_filename }} <span style="color: #f44336;">(check to delete)</span>
          </label>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <!-- New attachments upload -->
      <div style="margin-bottom: 12px;">
        <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px; font-weight: 600;">
          <i class="ph ph-paperclip"></i> Add New Attachments (optional)
        </label>
        <input
          type="file"
          name="attachments"
          multiple
          accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.txt,.ppt,.pptx"
          style="padding: 10px; background: rgba(23, 27, 46, 0.8); color: #e4e6eb; width: 100%;">
        <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
          Allowed: PDFs, Images, Documents â€¢ Max 16MB per file
        </div>
      </div>

      <!-- Action buttons for the edit form -->
      <div style="display: flex; gap: 10px;">
        <button type="submit" class="btn-small btn-edit"><i class="ph ph-floppy-disk"></i> Save Changes</button>
        <button type="button" class="btn-small btn-cancel" onclick="toggleEdit('{{ n.id }}')"><i class="ph ph-x"></i> Cancel</button>
      </div>
    </form>
  </div>

  <!-- Action buttons section -->
  <div class="note-actions">
    <!-- Edit and Delete buttons - Only show if user is logged in AND (owns the note OR is an admin) -->
    {% if current_user is not none and (current_user.id == n.user_id or current_user.is_admin) %}
      <!-- Edit button - toggles the edit form -->
      <button class="btn-small btn-edit" onclick="toggleEdit('{{ n.id }}')"><i class="ph ph-pencil"></i> Edit</button>

      <!-- Delete button - removes the note -->
      <form method="POST" action="/delete/{{ n.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this note?');">
        <button type="submit" class="btn-small btn-delete"><i class="ph ph-trash"></i> Delete</button>
      </form>
    {% endif %}

    <!-- Like button - available to all users -->
    <form method="POST" action="/like/{{ n.id }}" style="display:inline; margin-left:8px;">
      <button type="submit" class="btn-small" title="Like"><i class="ph-fill ph-heart" style="color: #ef4444;"></i> Like</button>
    </form>
  </div>

  <!-- Quick comment form -->
  <div style="margin-top: 12px;">
    <form method="POST" action="/comment/{{ n.id }}" style="display:flex; gap:8px; align-items:center;">
      {% if current_user is none %}
        <input type="text" name="comment_author" placeholder="Name" style="padding:8px 12px; border-radius:8px; border:1px solid rgba(102,126,234,0.2); background: rgba(23,27,46,0.6); color:#e4e6eb; font-size:13px; width:140px;">
      {% endif %}
      <input type="text" name="comment_body" placeholder="Add a short comment" style="flex:1; padding:8px 12px; border-radius:8px; border:1px solid rgba(102,126,234,0.2); background: rgba(23,27,46,0.6); color:#e4e6eb; font-size:13px;">
      <button type="submit" class="btn-small btn-edit"><i class="ph ph-chat-circle"></i></button>
    </form>
  </div>
</div>
{% endfor %}
