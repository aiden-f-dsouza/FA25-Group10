<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Class Notes - UIUC Turbolearn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ===== MAJOR CHANGE #1: External CSS System ===== -->
  <!-- BEFORE: All styles were inline in a <style> tag with hardcoded colors -->
  <!-- NOW: Uses turbolearn-darkmode.css with CSS custom properties for light/dark mode support -->
  <link rel="stylesheet" href="{{ url_for('static', filename='turbolearn-darkmode.css') }}">
  
  <!-- ===== MAJOR CHANGE #2: Typography System ===== -->
  <!-- BEFORE: Used generic system fonts -->
  <!-- NOW: Uses Google Fonts (Merriweather for headings, Inter for body text) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Choices.js for searchable dropdowns -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <!-- Notes page specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='notes-page.css') }}">
</head>
<body>
  <!-- Hidden data for JavaScript -->
  <div id="page-data"
       style="display: none;"
       data-page="{{ page|default(1) }}"
       data-classes='{{ classes | tojson }}'
       data-selected-filter="{{ selected_filter or 'All' }}">
  </div>

  <!-- Header with theme toggle and search -->
  <header class="tl-header">
    <div class="tl-container">
      <nav class="tl-nav">
        <a href="{{ url_for('home') }}" class="tl-logo">
          <div class="tl-logo-mark">TL</div>
          <div class="tl-logo-text">
            <span class="tl-logo-main">UIUC Turbolearn</span>
            <span class="tl-logo-sub">Class Notes</span>
          </div>
        </a>

        <div class="tl-nav-actions">
          <!-- Search bar in header -->
          <form method="get" action="/notes-feed" class="header-search-form">
            <input
              type="text"
              name="search"
              class="header-search-input"
              placeholder="üîç Search notes..."
              value="{{ search_query or '' }}"
            >
          </form>

          <!-- AI Summarizer link -->
          <a href="/summarizer" style="color: var(--tl-text-primary); text-decoration: none; padding: 8px 16px; margin: 0 8px; white-space: nowrap;">AI Summarizer</a>

          <!-- Theme toggle -->
          <button class="theme-toggle" aria-label="Toggle dark mode">
            <span class="moon-icon">üåô</span>
            <span class="sun-icon">‚òÄÔ∏è</span>
          </button>
        </div>

        
      </nav>
    </div>
  </header>

  <!-- ===== Main Content (Functionality Unchanged) ===== -->
  <!-- All functionality below is the same as index.html, just with updated styling -->
  <div class="notes-page">
    <div class="tl-container">
      <div class="notes-title">üëã Welcome to UIUC Turbolearn!</div>

      <!-- Share Your Notes Section -->
      <div class="section-card">
        <div class="section-header-row">
          <h2 class="section-heading">üìù Share Your Notes</h2>
          <button class="btn btn-accent" onclick="openModal()">Add Note +</button>
        </div>
      </div>

      <!-- Find Your Course Section -->
      <div class="section-card">
        <h2 class="section-heading">üîç Find Your Course</h2>
        <form method="get" action="/notes-feed" id="course-filter-form">
          <!-- Hidden fields to preserve other filters -->
          <input type="hidden" name="search" value="{{ search_query or '' }}">
          <input type="hidden" name="author_filter" value="{{ author_filter or 'All' }}">
          <input type="hidden" name="date_filter" value="{{ date_filter or 'All' }}">
          <input type="hidden" name="sort_by" value="{{ sort_by or 'recent' }}">
          
          <div style="display: flex; gap: 16px; margin-top: 16px;">
            <!-- Subject Dropdown -->
            <select id="subject-select" name="subject" class="course-select">
              <option value="">All Subjects</option>
            </select>
            
            <!-- Number Dropdown -->
            <select id="number-select" name="number" class="course-select">
              <option value="">All Numbers</option>
            </select>
            
            <!-- Hidden field to store combined class value for backend -->
            <input type="hidden" name="class_filter" id="class-filter-hidden" value="{{ selected_filter or 'All' }}">
          </div>
        </form>
      </div>

      <!-- Posted Notes Section -->
      <div class="section-card">
        <div class="section-header-row">
          <h2 class="section-heading">üìö Posted Notes</h2>
          
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <!-- Note count -->
            <div class="note-count">{{ total }} notes</div>
            
            <!-- Date filter dropdown -->
            <form method="get" action="/notes-feed" style="margin: 0;">
              <!-- Preserve current filters -->
              <input type="hidden" name="search" value="{{ search_query or '' }}">
              <input type="hidden" name="class_filter" value="{{ selected_filter or 'All' }}">
              <input type="hidden" name="author_filter" value="{{ author_filter or 'All' }}">
              <input type="hidden" name="sort_by" value="{{ sort_by or 'recent' }}">
              
              <select name="date_filter" onchange="this.form.submit()">
                <option value="All" {% if date_filter == "All" %}selected{% endif %}>All Time</option>
                <option value="Today" {% if date_filter == "Today" %}selected{% endif %}>Today</option>
                <option value="Week" {% if date_filter == "Week" %}selected{% endif %}>This Week</option>
                <option value="Month" {% if date_filter == "Month" %}selected{% endif %}>This Month</option>
              </select>
            </form>
            
            <!-- Sort dropdown -->
            <form method="get" action="/notes-feed" style="margin: 0;">
              <!-- Preserve current filters -->
              <input type="hidden" name="search" value="{{ search_query or '' }}">
              <input type="hidden" name="class_filter" value="{{ selected_filter or 'All' }}">
              <input type="hidden" name="author_filter" value="{{ author_filter or 'All' }}">
              <input type="hidden" name="date_filter" value="{{ date_filter or 'All' }}">
              
              <select name="sort_by" onchange="this.form.submit()">
                <option value="recent" {% if sort_by == "recent" %}selected{% endif %}>Most Recent</option>
                <option value="oldest" {% if sort_by == "oldest" %}selected{% endif %}>Oldest First</option>
                <option value="title" {% if sort_by == "title" %}selected{% endif %}>Title (A-Z)</option>
                <option value="author" {% if sort_by == "author" %}selected{% endif %}>Author (A-Z)</option>
              </select>
            </form>
          </div>
        </div>
      </div>
   
      <!-- Notes Feed -->
      <div id="notes-container">
      {% for n in notes %}
      <div class="card">
        <!-- Note content -->
        <div id="note-content-{{ n.id }}" class="note-content">
          <div class="note-title">{{ n.title }}</div>
          <div class="note-meta">
            <span class="meta-tag">üë§ {{ n.author }}</span>
            <span class="meta-tag">üìÖ {{ n.created }}</span>
            <span class="meta-tag">üìö {{ n.class }}</span>
          </div>
          <div class="note-body">{{ n.body }}</div>
          {% if n.attachments %}
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            {% for a in n.attachments %}
              {% if a.stored.lower().endswith('.png') or a.stored.lower().endswith('.jpg') or a.stored.lower().endswith('.jpeg') or a.stored.lower().endswith('.gif') %}
                <a href="{{ a.url }}" target="_blank"><img src="{{ a.url }}" alt="{{ a.orig }}" style="max-width:180px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);"></a>
              {% else %}
                <a href="{{ a.url }}" target="_blank" class="meta-tag">{{ a.orig }}</a>
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>

        <!-- Edit form -->
        <div id="edit-form-{{ n.id }}" class="edit-form">
          <form method="POST" action="/edit/{{ n.id }}">
            <div style="margin-bottom: 12px;">
              <input type="text" name="title" value="{{ n.title }}" placeholder="Note title" required>
            </div>
            <div style="margin-bottom: 12px;">
              <input type="text" name="author" value="{{ n.author }}" placeholder="Author name">
            </div>
            <div style="margin-bottom: 12px;">
              <select name="class">
                {% for c in classes %}
                <option value="{{ c }}" {% if c == n.class %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <div style="margin-bottom: 12px;">
              <textarea name="body" placeholder="Note content" required>{{ n.body }}</textarea>
            </div>
            <div style="display: flex; gap: 10px;">
              <button type="submit" class="btn-small btn-edit">üíæ Save Changes</button>
              <button type="button" class="btn-small btn-cancel" onclick="toggleEdit('{{ n.id }}')">‚ùå Cancel</button>
            </div>
          </form>
        </div>

        <!-- Action buttons -->
        <div class="note-actions">
          <button class="btn-small btn-edit" onclick="toggleEdit('{{ n.id }}')">‚úèÔ∏è Edit</button>
          <form method="POST" action="/delete/{{ n.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this note?');">
            <button type="submit" class="btn-small btn-delete">üóëÔ∏è Delete</button>
          </form>
        </div>
      </div>
      {% endfor %}
      </div>

      <!-- Load More button -->
      {% if has_more %}
        <div class="load-more-container">
          <button id="load-more" class="btn-small btn-edit" onclick="loadMore()">‚¨áÔ∏è Load More</button>
        </div>
      {% endif %}

      <!-- Empty state -->
      {% if notes|length == 0 %}
        <div class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <div>No notes found matching your filters.</div>
          <div style="font-size: 14px; margin-top: 8px;">Try adjusting your search or filters.</div>
        </div>
      {% endif %}

    </div>
  </div>

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='theme-toggle.js') }}"></script>
  <script src="{{ url_for('static', filename='notes-page.js') }}"></script>


<!-- ===== MODAL FOR CREATING NOTES ===== -->
  <div id="note-modal" class="modal-overlay">
    <div class="modal-content">
      <!-- Modal Header -->
      <div class="modal-header">
        <h2 class="modal-title">‚úçÔ∏è Create New Note</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <!-- Modal Body with Form -->
      <div class="modal-body">
        <form method="POST" action="/notes-feed" id="create-note-form" enctype="multipart/form-data">
          <div class="two">
            <input type="text" name="author" placeholder="Your name (optional)">
            <input type="text" name="title" placeholder="Note title">
          </div>

          <div style="margin-top: 16px;">
            <select name="class">
              {% for c in classes %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Editor + Preview -->
          <div style="margin-top: 16px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start;">
            <div>
              <label for="md-editor" style="display:block; margin-bottom:8px; font-weight:700;">Write (Markdown supported)</label>
              <textarea id="md-editor" name="body" placeholder="Write your note..." required style="min-height:160px;"></textarea>
            </div>
            <div>
              <label style="display:block; margin-bottom:8px; font-weight:700;">Live Preview</label>
              <div id="md-preview" class="note-body" style="min-height:160px; padding:12px; background:var(--tl-surface, rgba(23,27,46,0.6)); border-radius:8px; overflow:auto;"></div>
            </div>
          </div>

          <!-- Attachments: drag/drop, paste, multiple files -->
          <div style="margin-top: 12px;">
            <label style="display:block; margin-bottom:8px; font-weight:700;">Attachments (drag & drop, paste, or choose files)</label>
            <div id="dropzone" style="border:2px dashed rgba(102,126,234,0.2); padding:12px; border-radius:8px; text-align:center;">
              <div>Drop files here or click to choose</div>
              <input id="file-input" type="file" name="attachments" multiple style="display:none;" />
            </div>
            <div id="attachment-list" style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;"></div>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end; align-items:center;">
            <div id="upload-status" style="color: #a0a3bd; font-size:13px;">No files selected</div>
            <button type="button" class="btn-small btn-cancel" onclick="closeModal()">Cancel</button>
            <button type="button" id="submit-ajax" class="btn-search">üìù Post Note</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Markdown renderer + paste/drag-drop/upload JS -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
  <script>
  // Live markdown preview (debounced)
  (function(){
    const editor = document.getElementById('md-editor');
    const preview = document.getElementById('md-preview');
    if(editor && preview){
      function render(){
        const md = editor.value || '';
        const html = DOMPurify.sanitize(marked.parse(md, { gfm:true, breaks:true }));
        preview.innerHTML = html;
      }
      let t;
      editor.addEventListener('input', ()=>{ clearTimeout(t); t = setTimeout(render, 250); });
      render();
    }
  })();

  // Drag & drop + paste + file preview + AJAX upload
  (function(){
    const drop = document.getElementById('dropzone');
    const input = document.getElementById('file-input');
    const list = document.getElementById('attachment-list');
    const status = document.getElementById('upload-status');
    const submitBtn = document.getElementById('submit-ajax');
    const form = document.getElementById('create-note-form');
    if(!form) return;
    let files = [];

    function renderList(){
      list.innerHTML = '';
      if(files.length===0){ status.textContent = 'No files selected'; return; }
      status.textContent = files.length + ' file(s) ready';
      files.forEach((f, idx)=>{
        const card = document.createElement('div');
        card.style.minWidth='120px'; card.style.border='1px solid rgba(255,255,255,0.04)'; card.style.padding='8px'; card.style.borderRadius='8px'; card.style.background='rgba(0,0,0,0.04)';
        const name = document.createElement('div'); name.textContent = f.name; name.style.fontSize='13px'; name.style.marginBottom='8px';
        card.appendChild(name);
        if(f.type && f.type.startsWith('image/')){
          const img = document.createElement('img'); img.src = URL.createObjectURL(f); img.style.maxWidth='120px'; img.style.maxHeight='80px'; img.style.display='block'; img.style.marginBottom='8px'; card.appendChild(img);
        }
        const p = document.createElement('progress'); p.max=100; p.value=0; p.style.width='100%'; p.id='prog-'+idx; card.appendChild(p);
        const remove = document.createElement('button'); remove.textContent='Remove'; remove.style.marginTop='8px'; remove.className='chip'; remove.addEventListener('click', ()=>{ files.splice(idx,1); renderList(); });
        card.appendChild(remove);
        list.appendChild(card);
      });
    }

    drop.addEventListener('click', ()=> input.click());
    input.addEventListener('change', (e)=>{ for(const f of e.target.files) files.push(f); renderList(); input.value=''; });

    drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.style.borderColor='rgba(102,126,234,0.6)'; });
    drop.addEventListener('dragleave', (e)=>{ drop.style.borderColor='rgba(102,126,234,0.2)'; });
    drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.style.borderColor='rgba(102,126,234,0.2)'; for(const f of e.dataTransfer.files) files.push(f); renderList(); });

    // paste images from clipboard
    document.addEventListener('paste', (e)=>{
      const items = e.clipboardData && e.clipboardData.items;
      if(!items) return;
      for(const it of items){
        if(it.kind==='file'){
          const f = it.getAsFile(); if(f) files.push(f);
        }
      }
      renderList();
    });

    // AJAX submit with per-file progress
    submitBtn.addEventListener('click', ()=>{
      const fd = new FormData(form);
      files.forEach(f=> fd.append('attachments', f));

      const xhr = new XMLHttpRequest();
      xhr.open('POST', form.action || '/notes-feed');

      xhr.upload.addEventListener('progress', (e)=>{
        if(e.lengthComputable){
          const total = e.total;
          // approximate per-file distribution
          let acc = 0;
          files.forEach((f, idx)=>{
            const p = document.getElementById('prog-'+idx);
            if(p){
              const ratio = Math.min(100, Math.floor((e.loaded/total)*100));
              p.value = ratio;
            }
          });
        }
      });

      xhr.onreadystatechange = function(){
        if(xhr.readyState===4){
          if(xhr.status>=200 && xhr.status<300){
            window.location.reload();
          } else {
            alert('Upload failed: '+xhr.statusText);
          }
        }
      };

      xhr.send(fd);
      // optimistic UI
      files.forEach((f,idx)=>{ const p=document.getElementById('prog-'+idx); if(p){ p.removeAttribute('value'); } });
    });

  })();
  </script>

</body>
</html>