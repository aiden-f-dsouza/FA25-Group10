<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Class Notes - UIUC Turbolearn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- External CSS System -->
  <link rel="stylesheet" href="{{ url_for('static', filename='turbolearn-darkmode.css') }}">

  <!-- Typography System -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Notes page specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='notes-page.css') }}">

  <style>
    /* Additional page-specific styles */
    body {
      padding-top: 70px;
      padding-bottom: 20px;
    }

    /* Container using theme system */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Navigation using new header styles */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--bg-overlay);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-light);
      z-index: 1000;
      padding: 0 20px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }

    .navbar-logo {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 800;
      color: var(--accent-terracotta);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .navbar-logo:hover {
      opacity: 0.8;
    }

    .navbar-nav {
      display: flex;
      gap: 24px;
      align-items: center;
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .navbar-nav a {
      color: var(--text-secondary);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
    }

    .navbar-nav a:hover {
      color: var(--text-primary);
      background: var(--bg-card);
    }

    .navbar-user {
      color: var(--text-tertiary);
      font-size: 14px;
    }

    .navbar-user a {
      color: var(--accent-terracotta);
      text-decoration: none;
      font-weight: 600;
    }

    .navbar-user a:hover {
      opacity: 0.8;
    }

    /* Page title */
    .title {
      font-family: var(--font-serif);
      font-size: clamp(2rem, 4vw, 2.8rem);
      font-weight: 900;
      margin-bottom: 30px;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    /* Modal styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(16, 21, 34, 0.85);
      backdrop-filter: blur(8px);
    }

    .modal-content {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-xl);
      max-width: 700px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      transform: scale(0.9);
      transition: transform 0.3s ease;
      z-index: 2001;
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      padding: 24px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    .modal-header h2 {
      font-family: var(--font-serif);
      font-size: 24px;
      font-weight: 900;
      color: var(--text-primary);
      margin: 0;
      letter-spacing: -0.02em;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 32px;
      cursor: pointer;
      padding: 0;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      line-height: 1;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 32px;
    }

    /* Responsive design */
    @media(max-width:768px) {
      .title { font-size: 32px; }
      .navbar-nav { display: none; }
      .filter-section { padding: 16px; }
      .card { padding: 20px; }
      .note-actions { flex-wrap: wrap; }

      .modal-content {
        width: 95%;
        max-height: 90vh;
      }

      .modal-header {
        padding: 20px 24px;
      }

      .modal-header h2 {
        font-size: 20px;
      }

      .modal-body {
        padding: 24px;
      }
    }
  </style>

  <script>
    // ===== JAVASCRIPT FOR EDIT FUNCTIONALITY =====
    // Toggles the edit form visibility for a specific note
    function toggleEdit(noteId) {
      // Get the edit form and note content elements
      const editForm = document.getElementById('edit-form-' + noteId);
      const noteContent = document.getElementById('note-content-' + noteId);

      // Toggle the 'active' class to show/hide edit form
      editForm.classList.toggle('active');
      // Toggle the 'editing' class to show/hide note content
      noteContent.classList.toggle('editing');
    }

    // ===== JAVASCRIPT FOR CREATE NOTE MODAL =====
    // Opens the create note modal with animation
    function openCreateModal() {
      {% if current_user is not none %}
        const modal = document.getElementById('createNoteModal');
        if (modal) {
          modal.classList.add('active');
          // Prevent body scroll when modal is open
          document.body.style.overflow = 'hidden';
        }
      {% else %}
        // Redirect to login with message for non-logged-in users
        window.location.href = "{{ url_for('login') }}?message=Please log in to create a note";
      {% endif %}
    }

    // Closes the create note modal with animation
    function closeCreateModal() {
      const modal = document.getElementById('createNoteModal');
      if (modal) {
        modal.classList.remove('active');
        // Restore body scroll when modal is closed
        document.body.style.overflow = '';
      }
    }

    // Close modal when pressing Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeCreateModal();
      }
    });
  </script>
</head>
<body>
  <!-- Navigation Header -->
  <nav class="navbar">
    <a href="{{ url_for('home') }}" class="navbar-logo">üìö UIUC Turbolearn</a>
    <ul class="navbar-nav">
      <li><a href="/notes">üìù Notes Feed</a></li>
      <li><a href="#" onclick="openCreateModal(); return false;">‚úçÔ∏è Create Note</a></li>
      <li><a href="/notes#filters">üîç Filters</a></li>
      <li><a href="/summarizer">AI Summarizer</a></li>
      <li><a href="#" onclick="scrollToTop(); return false;">‚¨ÜÔ∏è Top</a></li>

      <!-- Theme toggle button -->
      <li>
        <button class="theme-toggle" aria-label="Toggle dark mode">
          <span class="moon-icon">üåô</span>
          <span class="sun-icon">‚òÄÔ∏è</span>
        </button>
      </li>

      <!-- User authentication section in navbar -->
      {% if current_user is not none %}
        <li class="navbar-user">
          Welcome, <a href="{{ url_for('profile') }}">{{ current_user.email }}</a>
        </li>
        <li><a href="{{ url_for('logout') }}" style="color: var(--accent-terracotta); opacity: 0.8;">Logout</a></li>
      {% else %}
        <li><a href="{{ url_for('login') }}">Login</a></li>
        <li><a href="{{ url_for('signup') }}">Sign Up</a></li>
      {% endif %}
    </ul>
  </nav>

  <div class="container">
    <div class="title" style="margin-top: 10px;">üìö Class Notes</div>

    <!-- Filter and Search Bar -->
    <!-- This form contains all filters: class, author, date range, search, and sort options -->
    <div id="filters" class="filter-section">
      <form method="get" action="/" class="filter-form">
        <!-- preserve tag filter when submitting other filters -->
        <input type="hidden" name="tag_filter" value="{{ tag_filter or 'All' }}">

        <!-- Row 1: Main filters (Class, Author, Date Range, Sort) -->
        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">

          <!-- Filter by class (CS124, MATH221, etc.) -->
          <select name="class_filter" onchange="this.form.submit()" style="min-width: 150px;">
            <option value="All" {% if selected_filter == "All" %}selected{% endif %}>All Classes</option>
            {% for c in classes %}
            <option value="{{ c }}" {% if selected_filter == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>

          <!-- Filter by author (shows all users who have posted notes) -->
          <select name="author_filter" onchange="this.form.submit()" style="min-width: 150px;">
            <option value="All" {% if author_filter == "All" %}selected{% endif %}>All Authors</option>
            {% for a in authors %}
            <option value="{{ a }}" {% if author_filter == a %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
          </select>

          <!-- Filter by date range (today, this week, this month, all time) -->
          <select name="date_filter" onchange="this.form.submit()" style="min-width: 150px;">
            <option value="All" {% if date_filter == "All" %}selected{% endif %}>All Time</option>
            <option value="Today" {% if date_filter == "Today" %}selected{% endif %}>Today</option>
            <option value="Week" {% if date_filter == "Week" %}selected{% endif %}>This Week</option>
            <option value="Month" {% if date_filter == "Month" %}selected{% endif %}>This Month</option>
          </select>

          <!-- Sort options (how to order the results) -->
          <select name="sort_by" onchange="this.form.submit()" style="min-width: 150px;">
            <option value="recent" {% if sort_by == "recent" %}selected{% endif %}>Most Recent</option>
            <option value="oldest" {% if sort_by == "oldest" %}selected{% endif %}>Oldest First</option>
            <option value="title" {% if sort_by == "title" %}selected{% endif %}>Title (A-Z)</option>
            <option value="author" {% if sort_by == "author" %}selected{% endif %}>Author (A-Z)</option>
            <option value="most_liked" {% if sort_by == "most_liked" %}selected{% endif %}>Most Liked</option>
            <option value="most_commented" {% if sort_by == "most_commented" %}selected{% endif %}>Most Commented</option>
            <option value="popular" {% if sort_by == "popular" %}selected{% endif %}>Top (Comments + Likes)</option>
          </select>
          <!-- Quick top filter button: sorts by popularity (comments then likes) -->
          <button type="button" style="margin-left:8px;" onclick="setPopularSort()">‚≠ê Top</button>

          <!-- Note count display badge -->
          <div class="note-count" style="margin-left: auto;">
            {{ total }} notes
          </div>
        </div>

        <!-- Row 2: Search bar -->
        <div style="display: flex; gap: 12px; align-items: center;">
          <!-- Text input for searching note titles and content -->
          <input type="text" name="search" placeholder="üîç Search notes..." value="{{ search_query or '' }}" style="flex: 1; min-width: 200px;">

          <!-- Submit button to apply search and filters -->
          <button type="submit" style="white-space: nowrap;">Search</button>
        </div>

      </form>
      <!-- Tag cloud -->
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        {% for tag, count in tags[:30] %}
          <a href="/?tag_filter={{ tag }}" class="meta-tag" style="text-decoration:none;">#{{ tag }} ({{ count }})</a>
        {% endfor %}
      </div>
    </div>

    <!-- Notes Feed -->
    <!-- Each note is displayed as a card with title, metadata, and content -->
    <div id="notes-feed" style="margin-top: 20px;">
    <div id="notes-container">
      {% for n in notes %}
      <div class="card">
        <!-- Note content (visible by default, hidden when editing) -->
        <div id="note-content-{{ n.id }}" class="note-content">
          <!-- Note title (clickable headline) -->
          <div class="note-title">{{ n.title }}</div>

          <!-- Metadata tags (author, date, class as badges) -->
          <div class="note-meta">
            <span class="meta-tag">üë§ {{ n.author }}</span>
            <span class="meta-tag">üìÖ {{ n.created.strftime('%Y-%m-%d %H:%M') }}</span>
            <span class="meta-tag">üìö {{ n.class_code }}</span>
            <span class="meta-tag">‚ù§Ô∏è {{ n.likes|length }}</span>
            <span class="meta-tag">üí¨ {{ n.comments|length }}</span>
            {# Tags badges on note #}
            {% if n.get_tags_list() %}
              {% for tag in n.get_tags_list() %}
                <a href="/?tag_filter={{ tag }}" class="meta-tag" style="text-decoration:none;">#{{ tag }}</a>
              {% endfor %}
            {% endif %}
            {# Hashtags badges on note #}
            {% if n.get_hashtags() %}
              {% for ht in n.get_hashtags() %}
                <a href="/?tag_filter={{ ht }}" class="meta-tag" style="text-decoration:none; background:rgba(245,101,101,0.2); color:#c53030;">#{{ ht }}</a>
              {% endfor %}
            {% endif %}
          </div>

          <!-- Note content/body -->
          <div class="note-body">{{ n.body }}</div>

          <!-- Attachments section (only show if note has attachments) -->
          {% if n.attachments %}
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(102, 126, 234, 0.2);">
            <div style="font-size: 13px; font-weight: 600; color: #a0a3bd; margin-bottom: 8px;">
              üìé Attachments ({{ n.attachments|length }}):
            </div>
            <!-- List of downloadable attachments -->
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              {% for attachment in n.attachments %}
              <!-- Each attachment as a download link with file type badge -->
              <a href="/download/{{ attachment.id }}"
                 style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(102, 126, 234, 0.2); border-radius: 8px; color: #667eea; text-decoration: none; font-size: 13px; transition: all 0.3s ease; border: 1px solid rgba(102, 126, 234, 0.3);"
                 onmouseover="this.style.background='rgba(102, 126, 234, 0.3)'; this.style.transform='translateY(-2px)'"
                 onmouseout="this.style.background='rgba(102, 126, 234, 0.2)'; this.style.transform='translateY(0)'">
                <!-- File type icon based on extension -->
                {% if attachment.file_type == 'pdf' %}üìÑ
                {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}üñºÔ∏è
                {% elif attachment.file_type in ['doc', 'docx'] %}üìù
                {% elif attachment.file_type in ['ppt', 'pptx'] %}üìä
                {% else %}üìé
                {% endif %}
                <!-- Display original filename -->
                <span>{{ attachment.original_filename }}</span>
                <!-- Download icon -->
                <span style="opacity: 0.7;">‚¨á</span>
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Edit form (hidden by default, shown when edit button is clicked) -->
        <div id="edit-form-{{ n.id }}" class="edit-form">
          <form method="POST" action="/edit/{{ n.id }}" enctype="multipart/form-data">
            <!-- Title input for editing -->
            <div style="margin-bottom: 12px;">
              <input type="text" name="title" value="{{ n.title }}" placeholder="Note title" required style="width: 100%;">
            </div>

            <!-- Author is fixed and cannot be changed (shows current author) -->
            <div style="margin-bottom: 12px; color: #888; font-size: 14px;">
              Author: {{ n.author }}
            </div>

            <!-- Class selector for editing -->
            <div style="margin-bottom: 12px;">
              <select name="class" style="width: 100%;">
                {% for c in classes %}
                <option value="{{ c }}" {% if c == n.class_code %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Body textarea for editing -->
            <div style="margin-bottom: 12px;">
              <textarea name="body" placeholder="Note content" required style="width: 100%; min-height: 120px;">{{ n.body }}</textarea>
            </div>

            <!-- Tags input for editing (comma-separated) -->
            <div style="margin-bottom: 12px;">
              <input type="text" name="tags" value="{{ n.get_tags_list()|join(', ') }}" placeholder="tags (comma-separated)" style="width:100%;">
            </div>

            <!-- Existing attachments management -->
            {% if n.attachments %}
            <div style="margin-bottom: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
              <div style="font-size: 13px; font-weight: 600; color: #a0a3bd; margin-bottom: 8px;">
                üìé Existing Attachments:
              </div>
              {% for attachment in n.attachments %}
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                <input type="checkbox" name="delete_attachments" value="{{ attachment.id }}" id="delete-{{ attachment.id }}">
                <label for="delete-{{ attachment.id }}" style="cursor: pointer; font-size: 13px; color: #e4e6eb;">
                  {% if attachment.file_type == 'pdf' %}üìÑ
                  {% elif attachment.file_type in ['png', 'jpg', 'jpeg', 'gif'] %}üñºÔ∏è
                  {% elif attachment.file_type in ['doc', 'docx'] %}üìù
                  {% elif attachment.file_type in ['ppt', 'pptx'] %}üìä
                  {% else %}üìé
                  {% endif %}
                  {{ attachment.original_filename }} <span style="color: #f44336;">(check to delete)</span>
                </label>
              </div>
              {% endfor %}
            </div>
            {% endif %}

            <!-- New attachments upload -->
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px; font-weight: 600;">
                üìé Add New Attachments (optional)
              </label>
              <input
                type="file"
                name="attachments"
                multiple
                accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.txt,.ppt,.pptx"
                style="padding: 10px; background: rgba(23, 27, 46, 0.8); color: #e4e6eb; width: 100%;">
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                Allowed: PDFs, Images, Documents ‚Ä¢ Max 16MB per file
              </div>
            </div>

            <!-- Action buttons for the edit form -->
            <div style="display: flex; gap: 10px;">
              <button type="submit" class="btn-small btn-edit">üíæ Save Changes</button>
              <button type="button" class="btn-small btn-cancel" onclick="toggleEdit({{ n.id }})">‚ùå Cancel</button>
            </div>
          </form>
        </div>

        <!-- Action buttons section -->
        <div class="note-actions">
          <!-- Edit and Delete buttons - Only show if user is logged in AND (owns the note OR is an admin) -->
          {% if current_user is not none and (current_user.id == n.user_id or current_user.is_admin) %}
            <!-- Edit button - toggles the edit form -->
            <button class="btn-small btn-edit" onclick="toggleEdit({{ n.id }})">‚úèÔ∏è Edit</button>

            <!-- Delete button - removes the note -->
            <form method="POST" action="/delete/{{ n.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this note?');">
              <button type="submit" class="btn-small btn-delete">üóëÔ∏è Delete</button>
            </form>
          {% endif %}

          <!-- Like button - available to all users -->
          <form method="POST" action="/like/{{ n.id }}" style="display:inline; margin-left:8px;">
            <button type="submit" class="btn-small" title="Like">‚ù§Ô∏è Like</button>
          </form>
        </div>

        <!-- Quick comment form -->
        <div style="margin-top: 12px;">
          <form method="POST" action="/comment/{{ n.id }}" style="display:flex; gap:8px; align-items:center;">
            {% if current_user is none %}
              <input type="text" name="comment_author" placeholder="Name" style="padding:8px 12px; border-radius:8px; border:1px solid rgba(102,126,234,0.2); background: rgba(23,27,46,0.6); color:#e4e6eb; font-size:13px; width:140px;">
            {% endif %}
            <input type="text" name="comment_body" placeholder="Add a short comment" style="flex:1; padding:8px 12px; border-radius:8px; border:1px solid rgba(102,126,234,0.2); background: rgba(23,27,46,0.6); color:#e4e6eb; font-size:13px;">
            <button type="submit" class="btn-small btn-edit">üí¨</button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    </div>

    {% if has_more %}
      <div style="text-align: center; margin: 20px 0;">
        <button id="load-more" class="btn-small btn-edit" onclick="loadMore()">‚¨áÔ∏è Load More</button>
      </div>
    {% endif %}

    <!-- Empty state message when no notes match filters -->
    {% if notes|length == 0 %}
      <div class="empty-state">
        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
        <div>No notes found matching your filters.</div>
        <div style="font-size: 14px; margin-top: 8px;">Try adjusting your search or filters.</div>
      </div>
    {% endif %}

    <!-- Create Note Modal -->
    <!-- Modal popup for creating new notes - triggers from navbar button -->
    <!-- Only shown to logged-in users; anonymous users see login prompt in navbar -->
    {% if current_user is not none %}
    <div id="createNoteModal" class="modal">
      <!-- Dark backdrop - clicking it closes the modal -->
      <div class="modal-backdrop" onclick="closeCreateModal()"></div>

      <!-- Modal content container -->
      <div class="modal-content">
        <!-- Modal header with title and close button -->
        <div class="modal-header">
          <h2>‚úçÔ∏è Create New Note</h2>
          <button class="modal-close" onclick="closeCreateModal()" aria-label="Close modal">&times;</button>
        </div>

        <!-- Modal body with the create form -->
        <div class="modal-body">
          <!-- enctype="multipart/form-data" is REQUIRED for file uploads -->
          <form method="POST" action="/notes" enctype="multipart/form-data">
            <!-- Note title input (author is automatically set to logged-in user) -->
            <div>
              <input type="text" name="title" placeholder="Note title">
            </div>

            <!-- Class selector dropdown -->
            <div style="margin-top: 16px;">
              <select name="class">
                {% for c in classes %}
                <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Note content text area -->
            <div style="margin-top: 16px;">
              <textarea name="body" placeholder="Write your note..." required></textarea>
            </div>

            <!-- Tags input -->
            <div style="margin-top: 12px;">
              <input type="text" name="tags" placeholder="tags (comma-separated), e.g. exam, lecture">
            </div>

            <!-- File upload input -->
            <!-- The 'multiple' attribute allows users to select multiple files at once -->
            <div style="margin-top: 16px;">
              <label style="display: block; margin-bottom: 8px; color: #a0a3bd; font-size: 14px; font-weight: 600;">
                üìé Attach Files (optional)
              </label>
              <input
                type="file"
                name="attachments"
                multiple
                accept=".pdf,.png,.jpg,.jpeg,.gif,.doc,.docx,.txt,.ppt,.pptx"
                style="padding: 10px; background: rgba(23, 27, 46, 0.8); color: #e4e6eb; width: 100%;">
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                Allowed: PDFs, Images (PNG, JPG, GIF), Documents (DOC, DOCX, TXT, PPT, PPTX) ‚Ä¢ Max 16MB per file
              </div>
            </div>

            <!-- Submit button (aligned to right) -->
            <div style="margin-top: 20px; text-align: right;">
              <button type="submit">üìù Post Note</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <script>
    // Scroll to top function for navbar
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Pagination: Load more notes via AJAX
    let currentPage = parseInt("{{ page|default(1) }}", 10) || 1;
    async function loadMore() {
      currentPage += 1;
      const form = document.querySelector('.filter-form');
      const params = new URLSearchParams(new FormData(form));
      params.set('page', currentPage);
      const url = '/notes?' + params.toString();
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        const container = document.getElementById('notes-container');
        container.insertAdjacentHTML('beforeend', data.html);
        if (!data.has_more) {
          const btn = document.getElementById('load-more');
          if (btn) btn.style.display = 'none';
        }
      } catch (err) {
        console.error('Failed to load more notes', err);
      }
    }

    // Set popular sort (comments then likes) and submit the filter form
    function setPopularSort() {
      const select = document.querySelector('select[name="sort_by"]');
      if (select) {
        select.value = 'popular';
        select.form.submit();
      }
    }
  </script>

  <!-- Theme toggle script -->
  <script src="{{ url_for('static', filename='theme-toggle.js') }}"></script>
  </body>
</html>
